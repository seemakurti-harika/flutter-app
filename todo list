import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:intl/intl.dart';

// ===========================
// 1Ô∏è‚É£ MODEL: Task Definition
// ===========================
class Task {
  final String id;
  final String title;
  bool isCompleted;
  final DateTime? scheduledTime;

  Task({
    required this.id,
    required this.title,
    this.isCompleted = false,
    this.scheduledTime,
  });
}

// ===========================
// 2Ô∏è‚É£ STATE: TaskModel
// ===========================
class TaskModel extends ChangeNotifier {
  final List<Task> _tasks = [];

  List<Task> get tasks => [..._tasks];

  int get completedTaskCount => _tasks.where((t) => t.isCompleted).length;
  int get totalTaskCount => _tasks.length;
  bool get areAllTasksCompleted =>
      totalTaskCount > 0 && completedTaskCount == totalTaskCount;

  void addTask(String title, DateTime? scheduledTime) {
    if (title.isNotEmpty) {
      _tasks.add(Task(
        id: DateTime.now().millisecondsSinceEpoch.toString(),
        title: title,
        scheduledTime: scheduledTime,
      ));
      notifyListeners();
    }
  }

  void toggleTaskCompletion(String id) {
    final idx = _tasks.indexWhere((t) => t.id == id);
    if (idx != -1) {
      _tasks[idx].isCompleted = !_tasks[idx].isCompleted;
      notifyListeners();
    }
  }

  void removeTask(String id) {
    _tasks.removeWhere((t) => t.id == id);
    notifyListeners();
  }
}

// ===========================
// 3Ô∏è‚É£ STATE: ThemeModel
// ===========================
class ThemeModel extends ChangeNotifier {
  bool _isDarkMode = false;

  bool get isDarkMode => _isDarkMode;
  ThemeMode get themeMode => _isDarkMode ? ThemeMode.dark : ThemeMode.light;

  void toggleTheme() {
    _isDarkMode = !_isDarkMode;
    notifyListeners();
  }
}

// ===========================
// 4Ô∏è‚É£ MAIN FUNCTION
// ===========================
void main() {
  runApp(
    MultiProvider(
      providers: [
        ChangeNotifierProvider(create: (_) => TaskModel()),
        ChangeNotifierProvider(create: (_) => ThemeModel()),
      ],
      child: const TodoApp(),
    ),
  );
}

// ===========================
// 5Ô∏è‚É£ APP ROOT
// ===========================
class TodoApp extends StatelessWidget {
  const TodoApp({super.key});

  @override
  Widget build(BuildContext context) {
    return Consumer<ThemeModel>(
      builder: (context, themeModel, _) {
        return MaterialApp(
          title: 'My Task List',
          debugShowCheckedModeBanner: false,
          themeMode: themeModel.themeMode,
          theme: ThemeData(
            brightness: Brightness.light,
            colorScheme: ColorScheme.fromSeed(
              seedColor: Colors.deepPurple,
              brightness: Brightness.light,
            ),
            useMaterial3: true,
            textTheme: GoogleFonts.poppinsTextTheme(),
          ),
          darkTheme: ThemeData(
            brightness: Brightness.dark,
            colorScheme: ColorScheme.fromSeed(
              seedColor: Colors.deepPurple,
              brightness: Brightness.dark,
            ),
            useMaterial3: true,
            textTheme: GoogleFonts.poppinsTextTheme(ThemeData.dark().textTheme),
          ),
          home: const TodoScreen(),
        );
      },
    );
  }
}

// ===========================
// 6Ô∏è‚É£ TODO SCREEN (Main UI)
// ===========================
class TodoScreen extends StatelessWidget {
  const TodoScreen({super.key});

  void _showAddTaskDialog(BuildContext context) {
    showDialog(
      context: context,
      builder: (_) => const AddTaskDialog(),
    );
  }

  @override
  Widget build(BuildContext context) {
    final themeModel = Provider.of<ThemeModel>(context);

    return Scaffold(
      body: Stack(
        children: [
          // Gradient background
          AnimatedContainer(
            duration: const Duration(milliseconds: 600),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: themeModel.isDarkMode
                    ? [Colors.black87, Colors.deepPurple.shade900]
                    : [Colors.deepPurple.shade300, Colors.blueAccent.shade100],
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
              ),
            ),
          ),
          CustomScrollView(
            slivers: [
              SliverAppBar(
                expandedHeight: 200,
                floating: true,
                backgroundColor: Colors.transparent,
                elevation: 0,
                flexibleSpace: FlexibleSpaceBar(
                  background: Padding(
                    padding: const EdgeInsets.all(24),
                    child: Align(
                      alignment: Alignment.bottomLeft,
                      child: Column(
                        mainAxisAlignment: MainAxisAlignment.end,
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            'üóíÔ∏è My Task List',
                            style: GoogleFonts.poppins(
                              fontSize: 32,
                              fontWeight: FontWeight.bold,
                              color: Colors.white,
                            ),
                          ),
                          const SizedBox(height: 6),
                          Consumer<TaskModel>(
                            builder: (context, model, _) {
                              return Text(
                                model.totalTaskCount == 0
                                    ? 'No tasks yet. Add one!'
                                    : '${model.completedTaskCount} of ${model.totalTaskCount} tasks completed',
                                style: GoogleFonts.poppins(
                                  color: Colors.white70,
                                  fontSize: 16,
                                ),
                              );
                            },
                          ),
                        ],
                      ),
                    ),
                  ),
                ),
                actions: [
                  IconButton(
                    icon: Icon(
                      themeModel.isDarkMode
                          ? Icons.light_mode_outlined
                          : Icons.dark_mode_outlined,
                      color: Colors.white,
                      size: 26,
                    ),
                    tooltip: themeModel.isDarkMode
                        ? 'Switch to Light Mode'
                        : 'Switch to Dark Mode',
                    onPressed: themeModel.toggleTheme,
                  ),
                  const SizedBox(width: 8),
                ],
              ),
              SliverPadding(
                padding: const EdgeInsets.all(16),
                sliver: Consumer<TaskModel>(
                  builder: (context, model, _) {
                    if (model.tasks.isEmpty) {
                      return SliverFillRemaining(
                        hasScrollBody: false,
                        child: Center(
                          child: Text(
                            '‚ú® Nothing here yet!\nTap + to add your first task.',
                            textAlign: TextAlign.center,
                            style: GoogleFonts.poppins(
                              color: Colors.white,
                              fontSize: 18,
                            ),
                          ),
                        ),
                      );
                    }

                    return SliverList(
                      delegate: SliverChildBuilderDelegate(
                        (context, index) {
                          final task = model.tasks[index];
                          return AnimatedSwitcher(
                            duration: const Duration(milliseconds: 300),
                            child: TaskCard(task: task, key: ValueKey(task.id)),
                          );
                        },
                        childCount: model.tasks.length,
                      ),
                    );
                  },
                ),
              ),
            ],
          ),
        ],
      ),
      floatingActionButton: Container(
        decoration: BoxDecoration(
          shape: BoxShape.circle,
          boxShadow: [
            BoxShadow(
              color: Colors.deepPurpleAccent.withOpacity(0.5),
              blurRadius: 15,
              spreadRadius: 3,
            ),
          ],
        ),
        child: FloatingActionButton(
          backgroundColor: Colors.deepPurpleAccent,
          onPressed: () => _showAddTaskDialog(context),
          child: const Icon(Icons.add, size: 28),
        ),
      ),
    );
  }
}

// ===========================
// 7Ô∏è‚É£ ADD TASK DIALOG
// ===========================
class AddTaskDialog extends StatefulWidget {
  const AddTaskDialog({super.key});

  @override
  State<AddTaskDialog> createState() => _AddTaskDialogState();
}

class _AddTaskDialogState extends State<AddTaskDialog> {
  final TextEditingController _controller = TextEditingController();
  DateTime? _selectedDate;
  TimeOfDay? _selectedTime;

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  Future<void> _pickDate() async {
    final DateTime? picked = await showDatePicker(
      context: context,
      initialDate: _selectedDate ?? DateTime.now(),
      firstDate: DateTime.now(),
      lastDate: DateTime.now().add(const Duration(days: 365)),
    );
    if (picked != null) {
      setState(() => _selectedDate = picked);
    }
  }

  Future<void> _pickTime() async {
    final TimeOfDay? picked =
        await showTimePicker(context: context, initialTime: TimeOfDay.now());
    if (picked != null) {
      setState(() => _selectedTime = picked);
    }
  }

  void _addTask() {
    final title = _controller.text.trim();
    if (title.isEmpty) return;

    DateTime? scheduledDateTime;
    if (_selectedDate != null) {
      scheduledDateTime = DateTime(
        _selectedDate!.year,
        _selectedDate!.month,
        _selectedDate!.day,
        _selectedTime?.hour ?? 0,
        _selectedTime?.minute ?? 0,
      );
    }

    Provider.of<TaskModel>(context, listen: false)
        .addTask(title, scheduledDateTime);
    Navigator.pop(context);
  }

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: const Text('Add New Task'),
      content: SingleChildScrollView(
        child: Column(
          children: [
            TextField(
              controller: _controller,
              decoration: const InputDecoration(
                labelText: 'Task Title',
                border: OutlineInputBorder(),
              ),
            ),
            const SizedBox(height: 12),
            Row(
              children: [
                Expanded(
                  child: ElevatedButton.icon(
                    icon: const Icon(Icons.calendar_today),
                    label: const Text('Date'),
                    onPressed: _pickDate,
                  ),
                ),
                const SizedBox(width: 8),
                Expanded(
                  child: ElevatedButton.icon(
                    icon: const Icon(Icons.access_time),
                    label: const Text('Time'),
                    onPressed: _pickTime,
                  ),
                ),
              ],
            ),
            if (_selectedDate != null || _selectedTime != null) ...[
              const SizedBox(height: 10),
              Text(
                'Scheduled: ${_selectedDate != null ? DateFormat('MMM d, yyyy').format(_selectedDate!) : ''}'
                '${_selectedTime != null ? ' ${_selectedTime!.format(context)}' : ''}',
              ),
            ],
          ],
        ),
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.pop(context),
          child: const Text('Cancel'),
        ),
        ElevatedButton(
          onPressed: _addTask,
          child: const Text('Add Task'),
        ),
      ],
    );
  }
}

// ===========================
// 8Ô∏è‚É£ TASK CARD
// ===========================
class TaskCard extends StatelessWidget {
  final Task task;
  const TaskCard({required this.task, super.key});

  @override
  Widget build(BuildContext context) {
    bool isOverdue = false;
    bool isDueSoon = false;
    Color accent = Colors.grey;

    if (!task.isCompleted && task.scheduledTime != null) {
      final now = DateTime.now();
      final due = task.scheduledTime!;
      if (due.isBefore(now)) {
        isOverdue = true;
        accent = Colors.redAccent;
      } else if (due.difference(now) <= const Duration(hours: 1)) {
        isDueSoon = true;
        accent = Colors.orangeAccent;
      }
    }

    return AnimatedContainer(
      duration: const Duration(milliseconds: 300),
      margin: const EdgeInsets.symmetric(vertical: 6),
      decoration: BoxDecoration(
        color: task.isCompleted
            ? Colors.green.withOpacity(0.15)
            : isOverdue
                ? Colors.red.withOpacity(0.1)
                : isDueSoon
                    ? Colors.orange.withOpacity(0.1)
                    : Colors.white.withOpacity(0.8),
        borderRadius: BorderRadius.circular(12),
      ),
      child: ListTile(
        leading: Checkbox(
          shape: const CircleBorder(),
          value: task.isCompleted,
          onChanged: (_) {
            Provider.of<TaskModel>(context, listen: false)
                .toggleTaskCompletion(task.id);
          },
        ),
        title: Text(
          task.title,
          style: GoogleFonts.poppins(
            fontSize: 16,
            fontWeight: FontWeight.w500,
            decoration: task.isCompleted
                ? TextDecoration.lineThrough
                : TextDecoration.none,
          ),
        ),
        subtitle: task.scheduledTime != null
            ? Text(
                DateFormat('MMM d, hh:mm a').format(task.scheduledTime!) +
                    (isOverdue
                        ? " (Overdue)"
                        : isDueSoon
                            ? " (Soon)"
                            : ""),
                style: TextStyle(color: accent),
              )
            : null,
        trailing: IconButton(
          icon: const Icon(Icons.delete_outline, color: Colors.redAccent),
          onPressed: () {
            Provider.of<TaskModel>(context, listen: false).removeTask(task.id);
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(content: Text('"${task.title}" deleted')),
            );
          },
        ),
      ),
    );
  }
}
